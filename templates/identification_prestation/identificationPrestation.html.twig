{% extends 'base.html.twig' %}
{% block body %}


    {% if identificationPrestation is defined %}
        <div class="centered-content">
            <div class="my-2">
                <h2 class="text-2xl font-bold text-center text-black-500">Identification Prestation</h2>
            </div>
            <div class="max-w-sm mx-auto" id="divInfosIdentificationPrestation">
                <div class="mb-5">
                    <div style="display: flex ; justify-content: space-between" class="divSeparator">
                        <strong>Société : </strong> <span>{{ identificationPrestation.societe }}</span>
                    </div>
                </div>
                <div class="mb-5">
                    <div style="display: flex; justify-content: space-between" class="divSeparator">
                        <strong>Nom / Prénom : </strong> <span>{{ identificationPrestation.nomPrenom }}</span>
                    </div>
                </div>
                <div class="mb-5">
                    <div style="display: flex; justify-content: space-between" class="divSeparator">
                        <strong>Prestation : </strong> <span>{{ identificationPrestation.prestation }}</span>
                    </div>
                </div>
                <div class="mb-5">
                    <div style="display: flex; justify-content: space-between" class="divSeparator">
                        <strong>Commanditaire : </strong> <span>{{ identificationPrestation.commanditaire }}</span>
                    </div>
                </div>
                <div class="mb-5">
                    <div style="display: flex; justify-content: space-between" class="divSeparator">
                        <strong>Arrivé le, à : </strong> <span>{{ identificationPrestation.heureArrivee | date ('Y-m-d H:i:s' , 'Indian/Reunion' ) }}</span>
                    </div>
                </div>

                <input type="text" id="idPrestationDiv" value="{{ identificationPrestation.id }}" style="display: none">

                <div class="mb-5" id="divSignature">
                    <canvas id="signature" width="300" height="100"></canvas>
                    <div>
                        <button id="effacerSignature" type="button" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Effacer</button>
                        <button id="enregistrerSignature" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Enregistrer</button>
                    </div>
                </div>
            </div>

            <div>
                <a style="display: none" id="registerIdentification" onclick="return confirm('Êtes vous sûr que la prestation est terminée ?')" href="{{ path('app_identification_prestation_validate' , { 'id' : identificationPrestation.id })  }}"><button class="hover:bg-orange-900 bg-orange-900 dark:hover:bg-orange-500 text-white font-bold py-2 px-4 rounded">Valider formulaire ?</button></a>
            </div>
        </div>

        <div class="centered-content" style="width: 50vw !important;">
            <h1 style="margin-top: 2rem" class="text-2xl font-bold text-center text-black-500">Test Photo</h1>
            <div class="divFormInput" style="display: flex; flex-direction: column; justify-content: center; align-items: center">
                <video id="video" width="640" height="480" style="border: 1px solid black ; border-radius: 10px ; margin: 10px;" autoplay></video>
                <div style="display: flex">
                    <button id="camOn" style="border-radius: 10px; border : 1px solid black ; background-color: grey">Cam On</button>
                    <button id="camOff" style="border-radius: 10px; border : 1px solid black ; background-color: grey">Cam Off</button>
                    <button id="snap" style="border-radius: 10px; border : 1px solid black ; background-color: grey">Prendre une photo</button>
                </div>
                <canvas id="canvas" width="640" height="480" style="display: none"></canvas>
                <div style="display: flex">
                    <button id="effacer" style="display: none ; border-radius: 10px; border : 1px solid black ; background-color: grey">Effacer</button>
                    <button id="upload" style="display: none; border-radius: 10px; border : 1px solid black ; background-color: grey">Upload</button>
                </div>
            </div>
        </div>


        <!-- MODAL CONFIRMATION  -->

        <dialog id="modalConfirmationIdentificationPrestation">
            <p>Êtes vous sûr de garder cette signature ?</p>
            <div id="divBoutonsModaleConfirmationIdentificationPrestation">
                <button class="px-3 py-2 text-xs font-medium text-center text-white bg-red-700 rounded-lg hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800" id="cancelModalButton">Annuler</button>
                <button class="px-3 py-2 text-xs font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" id="confirmModalButton">Confirmer</button>
            </div>

        </dialog>

        <!-- MODAL CONFIRMATION  -->


    {% else %}
        <div class="centered-content">
            <div class="my-2" style="margin-top:2rem">
                <h2 class="text-2xl font-bold text-center text-black-500">Formulaire identification prestation</h2>
            </div>
            <div class="max-w-lg mx-auto" style="width: 25rem">
                {{ form_start(identificationPrestationForm) }}
                <div id="labelsInput">
                    <div class="mb-5">
                        <div style="display: flex" class="divSeparator">
                            <div class="inputSeparator">
                                {{ form_label(identificationPrestationForm.societe) }}
                            </div>
                            <div>
                                {{ form_widget(identificationPrestationForm.societe) }}
                            </div>
                        </div>
                        <div>
                            {{ form_errors(identificationPrestationForm.societe) }}
                        </div>
                    </div>
                    <div class="mb-5">
                        <div style="display: flex" class="divSeparator">
                            <div class="inputSeparator">
                                {{ form_label(identificationPrestationForm.nomPrenom) }}
                            </div>
                            <div>
                                {{ form_widget(identificationPrestationForm.nomPrenom) }}
                            </div>
                        </div>
                        <div>
                            {{ form_errors(identificationPrestationForm.nomPrenom) }}
                        </div>
                    </div>
                    <div class="mb-5">
                        <div style="display: flex" class="divSeparator">
                            <div class="inputSeparator">
                                {{ form_label(identificationPrestationForm.prestation) }}
                            </div>
                            <div>
                                {{ form_widget(identificationPrestationForm.prestation) }}
                            </div>
                        </div>
                        <div>
                            {{ form_errors(identificationPrestationForm.prestation) }}
                        </div>
                    </div>
                    <div class="mb-5">
                        <div style="display: flex" class="divSeparator">
                            <div class="inputSeparator">
                                {{ form_label(identificationPrestationForm.commanditaire) }}
                            </div>
                            <div>
                                {{ form_widget(identificationPrestationForm.commanditaire) }}
                            </div>
                        </div>
                        <div>
                            {{ form_errors(identificationPrestationForm.commanditaire) }}
                        </div>
                    </div>
                </div>
                <div>
                    {{ form_row( identificationPrestationForm.save) }}
                </div>

                {{ form_end(identificationPrestationForm) }}
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block title %}
    Formulaire | Identification | Prestation
{% endblock %}

{% block javascripts %}

    <script src="{{ asset('scripts/Signature.js') }}"></script>
    <script src="{{ asset('scripts/camera.js') }}"></script>

    <script>
        //On a chargé en premier la classe Signature juste au dessus, et maintenant, au chargement de la page, on appelle les event listener
        window.onload = () => {
            let canvas = new Signature("#signature")
            let idPrestationDiv = document.getElementById('idPrestationDiv');
            let idPrestation = idPrestationDiv.value;
            let confirmModal = document.getElementById('modalConfirmationIdentificationPrestation');
            let confirmModalTrue = document.getElementById('confirmModalButton');
            let confirmModalFalse = document.getElementById('cancelModalButton');
            let registerIdentification = document.getElementById('registerIdentification');

            document.querySelector('#effacerSignature').addEventListener( 'click' , ( event ) => {
                //Le preventDefault permet d'éviter que le lien s'active
                event.preventDefault();
                canvas.effacer()
            })
            document.querySelector('#enregistrerSignature').addEventListener( 'click' , ( event ) => {
                event.preventDefault();
                confirmModal.showModal();
                confirmModalTrue.addEventListener( "click", () => {
                    confirmModal.close()
                    registerIdentification.style.display = "block";
                    //On prépare les data à envoyer via le fetch
                    let data = {
                        image : canvas.genererImg(),
                        idPrestation : idPrestation
                    }
                    fetch('/identification_prestation/sign' , {
                        method : "POST" ,
                        body : JSON.stringify( data )
                    }).then((response ) => {
                        console.log(response);
                    })
                })
                confirmModalFalse.addEventListener('click' , () => {
                    confirmModal.close();
                })
            } )
        }
    </script>
{% endblock %}